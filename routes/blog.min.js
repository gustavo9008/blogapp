const express=require("express"),router=express.Router(),Blog=require("../models/blog"),User=require("../models/user"),Comment=require("../models/comment"),Profile=require("../models/profile"),middleWare=require("../middleware/loginMiddleWare"),sanitizeHtml=require("sanitize-html"),multer=require("multer"),{storage:storage,cloudinary:cloudinary}=require("../cloudinary/postIndex"),upload=multer({storage:storage});router.get("/",(req,res)=>res.redirect("blogs")),router.get("/blogs",middleWare.findProfile,middleWare.checkProfileRegistered,(req,res)=>{delete req.session.returnTo,Blog.find({}).sort({created:"-1"}).exec((err,blogs)=>err?(req.flash("error","oops something went wrong try again later ðŸ¤¦"),res.redirect("/notfound")):res.render("index",{blogs:blogs,currentUser:req.user}))}),router.get("/blogs/new",middleWare.isLoggedIn,middleWare.findProfile,(req,res)=>(res.render("new"),{profile:req.profile})),router.post("/blogs",middleWare.isLoggedIn,upload.single("file"),(req,res)=>{User.findById(req.user.id,(err,user)=>{if(err)return req.flash("error","Oh no!! something went wrong"),res.redirect("/blogs");{let dbody=req.body.body,cbody=sanitizeHtml(dbody,{allowedTags:sanitizeHtml.defaults.allowedTags.concat(["iframe","img"]),allowedAttributes:{img:["src","alt"],iframe:["src","width","height","allow","clipboard-write","encrypted-media","gyroscope","picture-in-picture","allowfullscreen"]},allowedIframeHostnames:["www.youtube.com"]}),title,author,newBlog={title:req.body.title,body:cbody,author:{id:req.user._id,username:req.user.username}};if(req.file){let image={url:req.file.path,filename:req.file.filename};newBlog.image=image,createBlog(newBlog)}function createBlog(post){Blog.create(post,(err,blog)=>{if(err)return res.status(400).send("error");Profile.findById(req.user.profile,(err,foundProfile)=>{if(err)return req.flash("error","Oh no!! something went wrong"),res.redirect("back");function imageURL(profile){return blog.profile.image=foundProfile.image[0].url}function genericPicColor(profile){return blog.profile.genericPic=foundProfile.genericPic}foundProfile.image[0]?imageURL(foundProfile):genericPicColor(foundProfile),blog.profile.id=foundProfile._id,blog.save(),foundProfile.blogs.push(blog),foundProfile.save();let redirectUrl=blog._id;return req.flash("success","Post was created.ðŸ™‚"),res.status(200).json(redirectUrl)})})}req.body.imageUrl&&(imageUrl=req.body.imageUrl,newBlog.imageUrl=imageUrl,createBlog(newBlog))}})}),router.get("/blogs/:id",middleWare.findProfile,(req,res,next)=>{req.user||(req.session.returnTo=req.originalUrl),Blog.findById(req.params.id).populate({path:"comments",options:{sort:{created:-1}}}).exec((err,foundBlog)=>err?(req.flash("error","Article not found"),res.redirect("/blogs")):!foundBlog&&req.session.profilePageURL?(req.flash("error","Article Not Found!!!"),res.redirect("/blogs/profile")):foundBlog?res.render("show",{blog:foundBlog,profile:req.profile,list:req.readingList}):(req.flash("error","Article Not Found!!!"),res.redirect("/blogs/profile")))}),router.get("/blogs/:id/edit",middleWare.isLoggedIn,middleWare.findProfile,(req,res)=>{Blog.findById(req.params.id,(err,foundBlog)=>err?res.redirect("/blogs"):res.render("edit",{blog:foundBlog,profile:req.profile}))}),router.put("/blogs/:id",middleWare.isLoggedIn,(req,res)=>{req.body.blog.body=sanitizeHtml(req.body.blog.body,{allowedTags:sanitizeHtml.defaults.allowedTags.concat(["iframe","img"]),allowedAttributes:{img:["src"],iframe:["src","width","height","allow","clipboard-write","encrypted-media","gyroscope","picture-in-picture","allowfullscreen"]},allowedIframeHostnames:["www.youtube.com"]}),Blog.findByIdAndUpdate(req.params.id,req.body.blog,(err,updatedBlog)=>err?res.redirect("/blogs"):(req.flash("success","Post was updated"),res.redirect("/blogs/"+req.params.id)))}),router.delete("/blogs/:id",middleWare.isLoggedIn,(req,res)=>{let b_id=req.params.id;return Blog.findById(req.params.id,(err,foundBlog)=>{foundBlog.image[0]&&cloudinary.uploader.destroy(foundBlog.image[0].filename),foundBlog.comments&&foundBlog.comments.forEach(comm=>Comment.findByIdAndRemove(comm,(err,commentFound)=>{Profile.findByIdAndUpdate(commentFound.profile,{$pull:{comments:commentFound.profile}},{safe:!0,multi:!0})}))}),Profile.findByIdAndUpdate(req.user.profile,{$pull:{blogs:b_id}},{safe:!0,multi:!0},(function(err,blog){err&&req.flash("error","oh no, something went wrong")})),Blog.findByIdAndRemove(req.params.id,err=>{if(err)return res.redirect("/blogs")}),req.flash("success","Post was deleted"),res.redirect("/blogs")}),router.post("/blogs/:id/reading",middleWare.isLoggedIn,(req,res)=>{Profile.findById(req.user.profile,(err,profile)=>{if(err)return res.status(404).send("profile");let blog_id,url,title,newUrl={blog_id:req.body.blog_id,url:req.body.url,title:req.body.title};return profile.readingList.push(newUrl),profile.save(),res.send("success")})}),router.put("/blogs/:id/reading",middleWare.isLoggedIn,(req,res)=>{let list_id=req.body.blog_id;Profile.findByIdAndUpdate(req.user.profile,{$pull:{readingList:{blog_id:list_id}}},{safe:!0,multi:!0},(function(err,model){return err?res.status(404).send("profile"):res.send("Remove from reading list!")}))}),module.exports=router;